<!DOCTYPE html>
<html data-bs-theme="light" lang="fr">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Mesure_De</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/Apercu_graphique.css">
    <link rel="stylesheet" href="assets/css/Main_login.css">
    <link rel="stylesheet" href="assets/css/Tableau_bord.css">
</head>

<body>
    <div class="container_h"><img src="assets/img/equans-smi.svg" width="230" height="110"></div>
    <div class="element">
        <div class="icon"></div><div>
    <button class='Backpage' id="Backpage">
        <div class="icon-wrapper">
            <svg width="25px" height="25px" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
                <path fill="#000000" d="M224 480h640a32 32 0 1 1 0 64H224a32 32 0 0 1 0-64z"></path>
                <path fill="#000000" d="m237.248 512 265.408 265.344a32 32 0 0 1-45.312 45.312l-288-288a32 32 0 0 1 0-45.312l288-288a32 32 0 1 1 45.312 45.312L237.248 512z"></path>
            </svg>
        </div>
        <p class="button-text"></p>
    </button>
</div>

<script>
    document.getElementById("Backpage").addEventListener("click", function() {
        window.location.href = "Tableau_bord.html";
    });
</script>
    </div>
    <div class="container_g"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightpick@1.3.4/css/lightpick.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightpick@1.3.4/lightpick.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div>
    <canvas id="graphiqueAvant" width="180" height="60"></canvas>
</div>

<div>
    <canvas id="graphiqueApres" width="180" height="60"></canvas>
</div>

<script>
    const ctxAvant = document.getElementById('graphiqueAvant').getContext('2d');
    const ctxApres = document.getElementById('graphiqueApres').getContext('2d');
    let chartAvant;
    let chartApres;
    let allData = {}; // Toute les information de la BDD sont ici

    function updateChart(ctx, chartInstance, startDate, endDate, label) {
        // Filtrer les données en fonction des dates de début et de fin
        const filteredData = Object.keys(allData)
            .filter(date => moment(date).isBetween(startDate, endDate, undefined, '[]'))
            .reduce((obj, key) => {
                obj[key] = allData[key];
                return obj;
            }, {});

        const labels = Object.keys(filteredData);
        const values = labels.map(date => filteredData[date]);

        if (chartInstance) {
            chartInstance.destroy();
        }

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: `Consommation en kWh (${label})`,
                    backgroundColor: 'rgba(0, 120, 215, 0.4)',
                    borderColor: 'rgba(0, 120, 215, 1)',
                    hoverBackgroundColor: 'rgba(0, 120, 215, 0.6)',
                    hoverBorderColor: 'rgba(0, 120, 215, 1)',
                    data: values,
                    barPercentage: 0.75,
                    categoryPercentage: 0.5
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'kWh'
                        }
                    },
                    x: {
                        grid: {
                            color: "transparent"
                        }
                    }
                }
            }
        });
    }

// Récupérer les données et afficher les graphiques
function getDataAndUpdateChart() {
    fetch('database.php')
        .then(response => response.json())
        .then(data => {
            const SommeDate = {};
            data.forEach(item => {
                const datePart = item.timestamp ? item.timestamp.substring(0, 10) : 'N/A';
                const valeur = parseFloat(item.valeur);

                if (datePart !== 'N/A') {
                    if (SommeDate[datePart]) {
                        SommeDate[datePart] += valeur;
                    } else {
                        SommeDate[datePart] = valeur;
                    }
                }
            });
            allData = SommeDate; // Stocke les données

            // Récupérer les dates depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const dateAvantParam = urlParams.get('dateAvant');
            const dateApresParam = urlParams.get('dateApres');

            let dateAvantDebut, dateAvantFin, dateApresDebut, dateApresFin;

            // Vérification et affichage du graphique "Avant-travaux" si une date est présente
            if (dateAvantParam) {
                const [startAvant, endAvant] = dateAvantParam.split(' - ');
                if (startAvant && endAvant) {
                    dateAvantDebut = moment(startAvant, 'DD/MM/YYYY');
                    dateAvantFin = moment(endAvant, 'DD/MM/YYYY');
                    chartAvant = updateChart(ctxAvant, chartAvant, dateAvantDebut, dateAvantFin, 'Avant-travaux');
                    const canvasAvantElement = document.getElementById('graphiqueAvant');
                    if (canvasAvantElement) {
                        canvasAvantElement.style.display = 'block'; // Assurez-vous qu'il est visible
                    }
                } else {
                    if (chartAvant) {
                        chartAvant.destroy();
                        chartAvant = null;
                    } else {
                        const canvasAvantElement = document.getElementById('graphiqueAvant');
                        if (canvasAvantElement) {
                            canvasAvantElement.style.display = 'none';
                        }
                    }
                }
            } else {
                if (chartAvant) {
                    chartAvant.destroy();
                    chartAvant = null;
                } else {
                    const canvasAvantElement = document.getElementById('graphiqueAvant');
                    if (canvasAvantElement) {
                        canvasAvantElement.style.display = 'none';
                    }
                }
            }

            // Vérification et affichage du graphique "Après-travaux" si une date est présente
            if (dateApresParam) {
                const [startApres, endApres] = dateApresParam.split(' - ');
                if (startApres && endApres) {
                    dateApresDebut = moment(startApres, 'DD/MM/YYYY');
                    dateApresFin = moment(endApres, 'DD/MM/YYYY');
                    chartApres = updateChart(ctxApres, chartApres, dateApresDebut, dateApresFin, 'Après-travaux');
                    const canvasApresElement = document.getElementById('graphiqueApres');
                    if (canvasApresElement) {
                        canvasApresElement.style.display = 'block'; // Assurez-vous qu'il est visible
                    }
                } else {
                    if (chartApres) {
                        chartApres.destroy();
                        chartApres = null;
                    } else {
                        const canvasApresElement = document.getElementById('graphiqueApres');
                        if (canvasApresElement) {
                            canvasApresElement.style.display = 'none';
                        }
                    }
                }
            } else {
                if (chartApres) {
                    chartApres.destroy();
                    chartApres = null;
                } else {
                    const canvasApresElement = document.getElementById('graphiqueApres');
                    if (canvasApresElement) {
                        canvasApresElement.style.display = 'none';
                    }
                }
            }

        })
        .catch(error => {
            console.error('Erreur lors de la récupération des données', error);
        });
}
    
    
//Taille du graphique
function resizeCanvas() {
        const canvasAvant = document.getElementById('graphiqueAvant');
        const canvasApres = document.getElementById('graphiqueApres');
        const container = canvasAvant.parentNode; // Utiliser le même parent pour les deux 
        canvasAvant.width = container.clientWidth;
        canvasAvant.height = container.clientHeight;
        canvasApres.width = container.clientWidth;
        canvasApres.height = container.clientHeight;

        // Met à jour les graphiques après le redimensionnement
        const urlParams = new URLSearchParams(window.location.search);
        const dateAvantParam = urlParams.get('dateAvant');
        const dateApresParam = urlParams.get('dateApres');
        let dateAvantDebut, dateAvantFin, dateApresDebut, dateApresFin;

        if (dateAvantParam) { // Vérifie si le paramètre de date "Avant" est présent
            const [startAvant, endAvant] = dateAvantParam.split(' - ');
            if (startAvant && endAvant) {
                dateAvantDebut = moment(startAvant, 'DD/MM/YYYY');
                dateAvantFin = moment(endAvant, 'DD/MM/YYYY');
                if (chartAvant) {
                    chartAvant.destroy();
                    chartAvant = updateChart(ctxAvant, null, dateAvantDebut, dateAvantFin, 'Avant-travaux');
                }
            } else if (chartAvant) {
                chartAvant.destroy();
                chartAvant = null;
            }
        } else if (chartAvant) {
            chartAvant.destroy();
            chartAvant = null;
        }

        if (dateApresParam) { // Vérifie si le paramètre de date "Après" est présent
            const [startApres, endApres] = dateApresParam.split(' - ');
            if (startApres && endApres) {
                dateApresDebut = moment(startApres, 'DD/MM/YYYY');
                dateApresFin = moment(endApres, 'DD/MM/YYYY');
                if (chartApres) {
                    chartApres.destroy();
                    chartApres = updateChart(ctxApres, null, dateApresDebut, dateApresFin, 'Après-travaux');
                }
            } else if (chartApres) {
                chartApres.destroy();
                chartApres = null;
            }
        } else if (chartApres) {
            chartApres.destroy();
            chartApres = null;
        }
    }

    window.addEventListener('resize', resizeCanvas);
    document.addEventListener('DOMContentLoaded', getDataAndUpdateChart);
</script></div>
    <div class="container_e"><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<div>
    <button class='PDF' id="PDF">PDF</button>
    <button class='CSV' id="CSV">CSV</button>
</div>

<script>
    //Exportation
    document.getElementById('PDF').addEventListener('click', function() {
        exportToPDF();
    });

    document.getElementById('CSV').addEventListener('click', function() {
        exportToCSV();
    });

    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape'); // Paysage
        const canvasAvant = document.getElementById('graphiqueAvant');
        const canvasApres = document.getElementById('graphiqueApres');
        let yPosition = 20; // Position verticale initiale pour le premier graphique
        const margin = 10;
        const imgWidth = 250; // Largeur de l'image dans le PDF

        // Vérifiez et ajoutez le premier graphique ("Avant-travaux")
        if (canvasAvant && canvasAvant.style.display !== 'none') {
            const imgDataAvant = canvasAvant.toDataURL('image/png');
            const imgHeightAvant = (canvasAvant.height * imgWidth) / canvasAvant.width;
            doc.addImage(imgDataAvant, 'PNG', margin, yPosition, imgWidth, imgHeightAvant);
            yPosition += imgHeightAvant + margin; // Augmenter la position pour le graphique suivant
        } else {
            console.log('Canvas "graphiqueAvant" non trouvé ou caché.');
        }

        // Vérifiez et ajoutez le deuxième graphique ("Après-travaux")
        if (canvasApres && canvasApres.style.display !== 'none') {
            const imgDataApres = canvasApres.toDataURL('image/png');
            const imgHeightApres = (canvasApres.height * imgWidth) / canvasApres.width;
            doc.addImage(imgDataApres, 'PNG', margin, yPosition, imgWidth, imgHeightApres);
        } else {
            console.log('Canvas "graphiqueApres" non trouvé ou caché.');
        }

        doc.save('graphiques.pdf');
    }

    function exportToCSV() {
        window.location.href = 'export-csv.php';
    }
</script>
</div>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</body>

</html>